<!DOCTYPE html>
<html>
    <head>
        <title>Chord Dancer</title>
        <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
        <script>
            const {
                Renderer,
                Stave,
                StaveNote,
                Voice,
                Formatter,
                Accidental,
                BarNote,
                TextNote
            } = Vex.Flow;

            
            class ChordHistory extends EventTarget {
                #states = [];
                #currentIndex = -1;

                get #currentChords() {
                    return this.#states[this.#currentIndex] ?? [];
                }
                
                get latestChord() {
                    return this.#currentChords[this.#currentChords.length - 1];
                }

                #pushState(chords) {
                    this.#states = [
                        ...this.#states.slice(0, this.#currentIndex + 1),
                        chords
                    ];

                    this.#currentIndex = this.#states.length - 1;

                    this.dispatchEvent(new CustomEvent("stateUpdated"));
                }

                push(chord) {
                    this.#pushState([
                        ...this.#currentChords,
                        chord
                    ]);
                }

                clear() {
                    if (this.latestChord) this.#pushState([]);
                }

                #setOctave(octave) {
                    this.#pushState([
                        ...this.#currentChords.slice(0, -1),
                        [
                            ...this.latestChord.slice(0, -1),
                            octave
                        ]
                    ]);
                }

                increaseOctave() {
                    this.#setOctave(this.latestChord[3] + 1);
                }

                decreaseOctave() {
                    this.#setOctave(this.latestChord[3] - 1);
                }

                get canUndo() {
                    return this.#currentIndex > -1;
                }

                undo() {
                    if (this.canUndo) {
                        --this.#currentIndex;
                        this.dispatchEvent(new CustomEvent("stateUpdated"));
                    }
                }

                get canRedo() {
                    return this.#currentIndex < this.#states.length - 1;
                }

                redo() {
                    if (this.canRedo) {
                        ++this.#currentIndex;
                        this.dispatchEvent(new CustomEvent("stateUpdated"));
                    }
                }

                map(func) {
                    return this.#currentChords.map(func);
                }

                get length() {
                    return this.#currentChords.length;
                }
                
                getChord(index) {
                    return this.#currentChords[index];
                }
            }

            class ChordPlayer extends EventTarget {
                #audioCtx = new AudioContext();
                #wave = this.#audioCtx.createPeriodicWave([0, 1, 3], [2, 0, 3]);
                #gainEnvelope;
                static #chordLength = 1;

                stopChord() {
                    if(this.#gainEnvelope) {
                        this.#gainEnvelope.gain.linearRampToValueAtTime(0, this.#audioCtx.currentTime + 0.1);
                        this.#gainEnvelope = undefined;
                    }
                }

                #defaultStopPlayback = () => this.stopChord();
                #stopPlayback = this.#defaultStopPlayback;
                stopPlayback() {
                    this.#stopPlayback();
                }

                #playChord(root, third, fifth, octave, onEnded) {
                    this.stopChord();

                    const freqs = [
                        440 * Math.pow(2, (root - 9 + octave * 12) / 12),
                        440 * Math.pow(2, (root + third - 9 + octave * 12) / 12),
                        440 * Math.pow(2, (root + fifth - 9 + octave * 12) / 12)
                    ];

                    this.#gainEnvelope = new GainNode(this.#audioCtx);
                    this.#gainEnvelope.gain.setValueAtTime(0, this.#audioCtx.currentTime);
                    this.#gainEnvelope.gain.linearRampToValueAtTime(1 / freqs.length, this.#audioCtx.currentTime + 0.1);
                    this.#gainEnvelope.gain.linearRampToValueAtTime(0, this.#audioCtx.currentTime + ChordPlayer.#chordLength);

                    const oscs = [];

                    for (const freq of freqs) {
                        const osc = this.#audioCtx.createOscillator();
                        osc.setPeriodicWave(this.#wave);
                        osc.frequency.value = freq;
                        osc.connect(this.#gainEnvelope).connect(this.#audioCtx.destination);
                        oscs.push(osc);
                    }

                    for (const osc of oscs) {
                        osc.start();
                        osc.stop(this.#audioCtx.currentTime + ChordPlayer.#chordLength);
                    }

                    oscs[0].onended = onEnded;
                }

                playChord(root, third, fifth, octave) {
                    this.#playChord(root, third, fifth, octave);
                }
                        
                playChords(chords) {
                    this.#stopPlayback();

                    let stopSignalSent = false;
                    this.dispatchEvent(new CustomEvent("playbackStarted"));

                    this.#stopPlayback = function () {
                        this.#stopPlayback = this.#defaultStopPlayback;
                        this.#stopPlayback();
                        stopSignalSent = true;
                        this.dispatchEvent(new CustomEvent("playbackEnded"));
                    }

                    const thisPlayer = this;

                    function playIndex(index) {
                        if (stopSignalSent == false) {

                            if (index < chords.length) {
                                thisPlayer.dispatchEvent(new CustomEvent("chordStarted", { detail: { index } }));
                                thisPlayer.#playChord(
                                    ...chords.getChord(index),
                                    () => {
                                        thisPlayer.dispatchEvent(new CustomEvent("chordEnded", { detail: { index } }));
                                        playIndex(index + 1);
                                    }
                                );
                            } else {
                                thisPlayer.dispatchEvent(new CustomEvent("playbackEnded"));
                            }
                        }
                    }

                    playIndex(0);
                }
            }

            class ChordHelper {
                static noteNames = Object.freeze(["C", "Câ™¯", "D", "Dâ™¯", "E", "F", "Fâ™¯", "G", "Gâ™¯", "A", "Aâ™¯", "B"]);

                static thirdNames= Object.freeze({
                    2: "sus2",
                    3: "min",
                    4: "maj",
                    5: "sus4"
                });

                static fifthNames = Object.freeze({
                    5: "ð„«5",
                    6: "â™­5",
                    7: "5",
                    8: "â™¯5"
                });

                static octaveNames =  Object.freeze(["-3", "-2", "-1", "+0", "+1", "+2", "+3"]);

                static thirds = Object.freeze({
                    "sus2": 2,
                    "min": 3,
                    "maj": 4,
                    "sus4": 5
                });

                static fifths = Object.freeze({
                    "perf4": 5,
                    "dim": 6,
                    "perf": 7,
                    "aug": 8
                });

                static chordNames =  Object.freeze({
                    [ChordHelper.thirds.sus2]: Object.freeze({
                        [ChordHelper.fifths.perf4]: "sus2ð„«5",
                        [ChordHelper.fifths.dim]: "sus2â™­5",
                        [ChordHelper.fifths.perf]: "sus2",
                        [ChordHelper.fifths.aug]: "sus2â™¯5"
                    }),
                    [ChordHelper.thirds.min]: Object.freeze({
                        [ChordHelper.fifths.perf4]: "minð„«5",
                        [ChordHelper.fifths.dim]: "dim",
                        [ChordHelper.fifths.perf]: "min",
                        [ChordHelper.fifths.aug]: "minâ™¯5"
                    }),
                    [ChordHelper.thirds.maj]: Object.freeze({
                        [ChordHelper.fifths.perf4]: "majð„«5",
                        [ChordHelper.fifths.dim]: "majâ™­5",
                        [ChordHelper.fifths.perf]: "maj",
                        [ChordHelper.fifths.aug]: "aug"
                    }),
                    [ChordHelper.thirds.sus4]: Object.freeze({
                        [ChordHelper.fifths.dim]: "sus4â™­5",
                        [ChordHelper.fifths.perf]: "sus4",
                        [ChordHelper.fifths.aug]: "sus4â™¯5"
                    })
                });

                static nameChord = function(root, third, fifth) {
                    const chordName = ChordHelper.chordNames[third][fifth];
                    if (chordName) {
                        return ` ${ChordHelper.noteNames[root]}${chordName}`;
                    } else {
                        return undefined;
                    }
                };
            
                static spellChord = function(root, third, fifth) {
                    const rootNodes = ChordHelper.noteNames[root];
                    const thirdNodes = ChordHelper.noteNames[(root + third) % 12];
                    const fifthNodes = ChordHelper.noteNames[(root + fifth) % 12];
                    return `${rootNodes} ${thirdNodes} ${fifthNodes}`;
                };

                static lowerRoot = function(root, third, fifth) {
                    const newRoot = (root - 1 + 12) % 12;
                    const newThird = (third + 1) % 12;
                    const newFifth = (fifth + 1) % 12;
                    
                    return [newRoot, newThird, newFifth];
                };
                
                static raiseRoot = function(root, third, fifth) {
                    const newRoot = (root + 1) % 12;
                    const newThird = (third - 1 + 12) % 12;
                    const newFifth = (fifth - 1 + 12) % 12;
                    
                    return [newRoot, newThird, newFifth];
                };
                
                static lowerThird = function(root, third, fifth) {
                    const newRoot = root;
                    const newThird = (third - 1 + 12) % 12;
                    const newFifth = fifth;
                    
                    return [newRoot, newThird, newFifth];
                };
                
                static raiseThird(root, third, fifth) {
                    const newRoot = root;
                    const newThird = (third + 1) % 12;
                    const newFifth = fifth;
                    
                    return [newRoot, newThird, newFifth];
                }
                
                static lowerFifth(root, third, fifth) {
                    const newRoot = root;
                    const newThird = third;
                    const newFifth = (fifth - 1 + 12) % 12;
                    
                    return [newRoot, newThird, newFifth];
                }
                
                static raiseFifth(root, third, fifth) {
                    const newRoot = root;
                    const newThird = third;
                    const newFifth = (fifth + 1) % 12;
                    
                    return [newRoot, newThird, newFifth];
                }
                
                static findRootPosition(root, third, fifth) {
                    if (
                        ChordHelper.chordNames[third] !== undefined
                        && ChordHelper.chordNames[third][fifth] !== undefined
                    ) {
                        return [root, third, fifth];
                    } else {
                        return null;
                    }
                }

                static findFirstInversion(root, third, fifth) {
                    const newRoot = (root + third) % 12;
                    const newThird = (12 + fifth - third) % 12;
                    const newFifth = (12 - third) % 12;

                    if (
                        ChordHelper.chordNames[newThird] !== undefined
                        && ChordHelper.chordNames[newThird][newFifth] !== undefined
                    ) {
                        return [newRoot, newThird, newFifth];
                    } else {
                        return null;
                    }
                }

                static findSecondInversion(root, third, fifth) {
                    const newRoot = (root + fifth) % 12;
                    const newThird = (12 - fifth) % 12;
                    const newFifth = (12 + third - fifth) % 12;

                    if (
                        ChordHelper.chordNames[newThird] !== undefined
                        && ChordHelper.chordNames[newThird][newFifth] !== undefined
                    ) {
                        return [newRoot, newThird, newFifth];
                    } else {
                        return null;
                    }
                }

                static findInversions(root, third, fifth) {
                    const rootPosition = ChordHelper.findRootPosition(root, third, fifth);
                    const firstInversion = ChordHelper.findFirstInversion(root, third, fifth);
                    const secondInversation = ChordHelper.findSecondInversion(root, third, fifth);

                    const inversions = [];
                    if (rootPosition) inversions.push(rootPosition);
                    if (firstInversion) inversions.push(firstInversion);
                    if (secondInversation) inversions.push(secondInversation);
                    return inversions;
                }
            };

            class StaveHelper {
                static metrics = Object.freeze({
                    chordWidth: 150,
                    clefWidth: 50,
                    staveHeight: 130,
                    topMargin: 30,
                    horizontalMargin: 20,
                    maxChords: 6
                });

                static noteNames = Object.freeze(["c", "c#", "d", "d#", "e", "f", "f#", "g", "g#", "a", "a#", "b"]);

                static createChord(root, third, fifth, octave) {
                    const position = 4 + octave;
                    const keys = [
                        `${StaveHelper.noteNames[root]}/${position}`,
                        `${StaveHelper.noteNames[(root + third) % 12]}/${position + Math.floor((root + third) / 12)}`,
                        `${StaveHelper.noteNames[(root + fifth) % 12]}/${position + Math.floor((root + fifth) / 12)}`
                    ];

                    const chord =  new StaveNote(
                        {
                            keys,
                            duration: "w"
                        }
                    );

                    for (const index in keys) {
                        if (keys[index].includes("#")) {
                            chord.addModifier(new Accidental("#"), parseInt(index))
                        }
                    }

                    return chord;
                }

                static nameChord(root, third, fifth) {
                    return new TextNote({
                        text: ChordHelper.nameChord(root, third, fifth),
                        duration: "w",
                        font: {
                            family: "system-ui",
                            size: 15,
                            weight: ""
                        },
                        justification: TextNote.Justification.LEFT,
                        line: 0
                    });
                }
            }


            function renderChordGraph(root, third, fifth, octave, target) {
                function getChordGraphElement(root, third, fifth, octave) {
                    function getChordCollectionElement(root, third, fifth, octave) {
                        function getChordElement(root, third, fifth, octave) {
                            if (root === null) return null;

                            const el = document.createElement("button");
                            el.setAttribute("type", "button");
                            el.classList.add("chord");
                            el.innerText = `${ChordHelper.nameChord(root, third, fifth)} (${ChordHelper.spellChord(root, third, fifth)})`;

                            el.addEventListener("click", () => {
                                el.dispatchEvent(new CustomEvent(
                                    "chordPushed",
                                    {
                                        bubbles: true,
                                        detail: [ root, third, fifth, octave ]
                                    }
                                ));
                            });
                            return el;
                        }

                        if (root === null) return null;

                        const el = document.createElement("div");
                        el.classList.add("chord-collection");
                        const inversions = ChordHelper.findInversions(root, third, fifth);
                        for (const inversion of inversions) {
                            el.append(getChordElement(...inversion, octave));
                        }
                        return el;
                    }

                    function getOctaveControlElement(octave) {
                        const el = document.createElement("div");

                        const upButton = document.createElement("button");
                        upButton.id = "octave-up";
                        upButton.innerText = "Octave Up";
                        upButton.addEventListener("click", () => {
                            el.dispatchEvent(new CustomEvent(
                                "octaveIncreased",
                                {
                                    bubbles: true
                                }
                            ));
                        });
                        el.appendChild(upButton);

                        const downButton = document.createElement("button");
                        downButton.id = "octave-down";
                        downButton.innerText = "Octave Down";
                        downButton.addEventListener("click", () => {
                            el.dispatchEvent(new CustomEvent(
                                "octaveDecreased",
                                {
                                    bubbles: true
                                }
                            ));
                        });
                        el.appendChild(downButton);

                        return el;
                    }

                    const table = document.createElement("div");
                    table.classList.add("chord-graph");
                    const topRow = document.createElement("div");
                    const middleRow = document.createElement("div");
                    const bottomRow = document.createElement("div");
                    topRow.append(
                        document.createElement("div"),
                        getChordCollectionElement(...ChordHelper.raiseRoot(root, third, fifth), octave),
                        getChordCollectionElement(...ChordHelper.raiseThird(root, third, fifth), octave)
                    );
                    middleRow.append(
                        getChordCollectionElement(...ChordHelper.lowerFifth(root, third, fifth), octave),
                        getChordCollectionElement(root, third, fifth, octave),
                        getChordCollectionElement(...ChordHelper.raiseFifth(root, third, fifth), octave)
                    );
                    bottomRow.append(
                        getChordCollectionElement(...ChordHelper.lowerThird(root, third, fifth), octave),
                        getChordCollectionElement(...ChordHelper.lowerRoot(root, third, fifth), octave),
                        getOctaveControlElement(octave)
                    );
                    table.append(topRow, middleRow, bottomRow);
                    return table;
                }

                const graph = getChordGraphElement(root, third, fifth, octave);
                const oldGraph = target.querySelector("& > .chord-graph");
                if (oldGraph) {
                    oldGraph.replaceWith(graph);
                } else {
                    target.append(graph);
                }
            }

            function renderStaves(chords, target) {
                function renderStave(notes, chordNames, context, top) {
                    const notesWidth = notes.length * StaveHelper.metrics.chordWidth;

                    const stave = new Stave(StaveHelper.metrics.horizontalMargin, top, notesWidth + StaveHelper.metrics.clefWidth);
                    stave.addClef("treble");
                    stave.setContext(context);

                    const voice = new Voice({ num_beats: notes.length, beat_value: 1 }).setContext(context);
                    const notesWithBarlines = [].concat(...notes.map(n => [n, new BarNote()])).slice(0, -1);
                    voice.addTickables(notesWithBarlines).setStave(stave);
                    
                    const chordNameVoice = new Voice({ num_beats: notes.length, beat_value: 1 }).setContext(context);
                    chordNames.forEach(chordName => {
                        chordName.setStave(stave);
                    });
                    const chordNamesWithBarlines =  [].concat(...chordNames.map(n => [n, new BarNote()])).slice(0, -1);

                    chordNameVoice.addTickables(chordNamesWithBarlines).setStave(stave);

                    new Formatter().joinVoices([voice, chordNameVoice]).format([voice, chordNameVoice], notesWidth);

                    stave.draw();
                    voice.draw();
                    chordNameVoice.draw();
                }

                const notes = chords.map(chord => StaveHelper.createChord(...chord));
                const chordNames = chords.map(chord => StaveHelper.nameChord(...chord));
                const staveCount = Math.ceil(notes.length / StaveHelper.metrics.maxChords);

                target.textContent = '';
                const renderer = new Renderer(target, Renderer.Backends.SVG);
                const canvasWidth = StaveHelper.metrics.maxChords * StaveHelper.metrics.chordWidth + StaveHelper.metrics.clefWidth + StaveHelper.metrics.horizontalMargin * 2;
                const canvasHeight = StaveHelper.metrics.topMargin + Math.max(1, staveCount) * StaveHelper.metrics.staveHeight;
                renderer.resize(canvasWidth, canvasHeight);
                const context = renderer.getContext();

                for (let staveIndex = 0; staveIndex < staveCount || staveIndex === 0; ++staveIndex) {
                    const staveNotes = notes.slice(staveIndex * StaveHelper.metrics.maxChords, (staveIndex + 1) * StaveHelper.metrics.maxChords);
                    const staveChordNames = chordNames.slice(staveIndex * StaveHelper.metrics.maxChords, (staveIndex + 1) * StaveHelper.metrics.maxChords);
                    renderStave(staveNotes, staveChordNames, context, StaveHelper.metrics.topMargin + staveIndex * (StaveHelper.metrics.staveHeight));
                }
            }


            customElements.define("chord-picker", class extends HTMLElement {
                rootPicker;
                thirdPicker;
                fifthPicker;
                octavePicker;
                button;

                static observedAttributes = ["root", "third", "fifth", "octave"];
                
                constructor() {
                    super();

                    const picker = this.attachShadow({ mode: "open" });

                    {
                        this.rootPicker = document.createElement("select");
                        this.rootPicker.setAttribute("part", "select");
                        this.rootPicker.addEventListener("change", () => this.updateButton());

                        for (const index in ChordHelper.noteNames) {
                            const option = document.createElement("option");
                            option.setAttribute("value", index);
                            option.innerText = ChordHelper.noteNames[index];
                            this.rootPicker.appendChild(option);
                        }

                        picker.appendChild(this.rootPicker);
                    }
 
                    {
                        this.thirdPicker = document.createElement("select");
                        this.thirdPicker.setAttribute("part", "select");
                        this.thirdPicker.addEventListener("change", () => this.updateButton());

                        for (const index in ChordHelper.thirdNames) {
                            const option = document.createElement("option");
                            option.setAttribute("value", index);
                            option.innerText = ChordHelper.thirdNames[index];
                            this.thirdPicker.appendChild(option);
                        }

                        picker.appendChild(this.thirdPicker);
                    }

                    {
                        this.fifthPicker = document.createElement("select");
                        this.fifthPicker.setAttribute("part", "select");
                        this.fifthPicker.addEventListener("change", () => this.updateButton());

                        for (const index in ChordHelper.fifthNames) {
                            const option = document.createElement("option");
                            option.setAttribute("value", index);
                            option.innerText = ChordHelper.fifthNames[index];
                            this.fifthPicker.appendChild(option);
                            
                        }

                        picker.appendChild(this.fifthPicker);
                    }

                    {
                        this.octavePicker = document.createElement("select");
                        this.octavePicker.setAttribute("part", "select");
                        for (const name of ChordHelper.octaveNames.toReversed()) {
                            const index = parseInt(name);
                            const option = document.createElement("option");
                            option.setAttribute("value", index);
                            option.innerText = name;
                            this.octavePicker.appendChild(option);
                        }
                        picker.appendChild(this.octavePicker);
                    }

                    {
                        this.button = document.createElement("button");
                        this.button.setAttribute("part", "button");
                        this.button.addEventListener("click", () => {
                            this.dispatchEvent(new CustomEvent(
                                "chordPushed",
                                {
                                    bubbles: true,
                                    detail: [
                                        parseInt(this.rootPicker.value),
                                        parseInt(this.thirdPicker.value),
                                        parseInt(this.fifthPicker.value),
                                        parseInt(this.octavePicker.value)
                                    ]
                                }
                            ));
                        });
                        picker.appendChild(this.button);
                    }
                }

                updateButton() {
                    const root = this.rootPicker.value;
                    const third = this.thirdPicker.value;
                    const fifth = this.fifthPicker.value;
                    const octave = this.octavePicker.value;
                    const chordName = ChordHelper.nameChord(root, third, fifth);
                    if (chordName) {
                        this.button.innerText = `${chordName} (${ChordHelper.spellChord(root, third, fifth)})`;
                        this.button.disabled = false;
                    } else {
                        this.button.innerText = "Chord undefined";
                        this.button.disabled = true;
                    }
                }


                attributeChangedCallback(name, oldValue, newValue) {
                    if (name === "root") this.rootPicker.value = newValue;
                    if (name === "third") this.thirdPicker.value = newValue;
                    if (name === "fifth") this.fifthPicker.value = newValue;
                    if (name === "octave") this.octavePicker.value = newValue;
                    this.updateButton();
                }
            });


            document.addEventListener("DOMContentLoaded", () => {
                const chordHistory = new ChordHistory();
                const chordPlayer = new ChordPlayer();

                chordHistory.addEventListener("stateUpdated", updateUI);

                chordPlayer.addEventListener("chordStarted", (event) => {
                    document.querySelectorAll(".vf-stavenote")?.[event.detail.index]?.classList.add("highlight");
                });

                chordPlayer.addEventListener("chordEnded", (event) => {
                    document.querySelectorAll(".vf-stavenote")?.[event.detail.index]?.classList.remove("highlight");
                });

                chordPlayer.addEventListener("playbackStarted", () => {
                    document.getElementById("stop").disabled = false;
                });

                chordPlayer.addEventListener("playbackEnded", () => {
                    document.getElementById("stop").disabled = true;
                    document.querySelector(".vf-stavenote.highlight")?.classList.remove("highlight");
                });

                function setInitialChord() {
                    renderChordGraph(0, ChordHelper.thirds.maj, ChordHelper.fifths.perf, 0, document.getElementById("navigator"));
                    const chordPicker = document.querySelector("chord-picker")
                    chordPicker.setAttribute("root", 0);
                    chordPicker.setAttribute("third", ChordHelper.thirds.maj);
                    chordPicker.setAttribute("fifth", ChordHelper.fifths.perf);
                    chordPicker.setAttribute("octave", 0);
                }

                function updateUI() {
                    chordPlayer.stopPlayback();
                    document.getElementById("stop").disabled = true;

                    if (chordHistory.latestChord) {
                        renderChordGraph(...chordHistory.latestChord, document.getElementById("navigator"));
                        
                        const chordPicker = document.querySelector("chord-picker")
                        chordPicker.setAttribute("root", chordHistory.latestChord[0]);
                        chordPicker.setAttribute("third", chordHistory.latestChord[1]);
                        chordPicker.setAttribute("fifth", chordHistory.latestChord[2]);
                        chordPicker.setAttribute("octave", chordHistory.latestChord[3]);

                        chordPlayer.playChord(...chordHistory.latestChord);
                        document.getElementById("clear").disabled = false;
                        document.getElementById("play").disabled = false;
                        document.getElementById("octave-up").disabled = chordHistory.latestChord[3] >= 3;
                        document.getElementById("octave-down").disabled = chordHistory.latestChord[3] <= -3;
                    } else {
                        setInitialChord();
                        document.getElementById("octave-up").disabled = true;
                        document.getElementById("octave-down").disabled = true;
                        document.getElementById("clear").disabled = true;
                        document.getElementById("play").disabled = true;
                    }
                    
                    document.getElementById("undo").disabled = !chordHistory.canUndo;
                    document.getElementById("redo").disabled = !chordHistory.canRedo;
                    
                    renderStaves(chordHistory, document.getElementById("staves"));
                }

                updateUI();

                document.addEventListener("chordPushed", () => chordHistory.push(event.detail));
                document.addEventListener("octaveIncreased", () => chordHistory.increaseOctave());
                document.addEventListener("octaveDecreased", () => chordHistory.decreaseOctave());
                document.getElementById("clear").addEventListener("click", () => chordHistory.clear());
                document.getElementById("undo").addEventListener("click", () => chordHistory.undo());
                document.getElementById("redo").addEventListener("click", () => chordHistory.redo());

                document.getElementById("play").addEventListener("click", () => chordPlayer.playChords(chordHistory));
                document.getElementById("stop").addEventListener("click", () => chordPlayer.stopPlayback());
            });
        </script>

        <style>
            html {
                font-family: system-ui;
                --theme-color: yellow;
                --border-radius: 0.4em;
                --chord-width: 11em;
            }

            body {
                display: flex;
                font-size: 1.2rem;
                flex-direction: column;
                align-items: center;
            }

            h1 {
                color: oklch(from var(--theme-color) 65% 20% h);
            }

            .chord-graph {
                display: table;
                border-spacing: 0.75em;

                > * {
                    display: table-row;
                    > * {
                        display: table-cell;
                        vertical-align: middle;
                        width: var(--chord-width);
                        height: 6em;
                    }
                }

                button {
                    margin: 0.25em 0;
                    width: 100%;
                }

                .chord-collection {
                    border: 0.15em solid oklch(from var(--theme-color) 80% 20% h);
                    border-radius: var(--border-radius);
                    background: oklch(from var(--theme-color) 98% 2% h);
                    padding: 0 0.25em;

                    .chord {
                        border: 0;
                        border-radius: var(--border-radius);
                        line-height: 0.9em;
                        text-align: left;

                        &:hover {
                            cursor: pointer;
                            background: oklch(from var(--theme-color) 90% 10% h);
                        }
                    }
                }
            }

            .buttons, chord-picker {
                margin: 1em 0;
            }

            chord-picker::part(button) {
                width: var(--chord-width);
                line-height: 1.2em;
            }

            button,
            chord-picker::part(select), chord-picker::part(button) {
                color: oklch(from var(--theme-color) 30% 30% h);
                border: 0.15em solid oklch(from var(--theme-color) 80% 20% h);
                border-radius: var(--border-radius);
                background: oklch(from var(--theme-color) 98% 2% h);
                padding: 0.25em 0.4em;
                margin: 0 0.4em;
                font-size: 1em;
                
                &:hover:not(:disabled, :active) {
                    background: oklch(from var(--theme-color) 90% 10% h);
                }
                
                &:active:not(:disabled)  {
                    background: oklch(from var(--theme-color) 94% 10% h);
                }

                &:disabled {
                    color: oklch(from var(--theme-color) 80% 10% h);
                    border-color: oklch(from var(--theme-color) 90% 10% h);
                    background: oklch(from var(--theme-color) 95% 2% h);
                }
            }

            .vf-stavenote.highlight {
                fill: oklch(from var(--theme-color) 70% 30% h);
            }
        </style>
    </head>
    <body>
        <h1>Chord Dancer</h1>
        <chord-picker></chord-picker>
        <div id="navigator"></div>
        <div class="buttons">
            <button type="button" id="undo">Undo</button>
            <button type="button" id="redo">Redo</button>
        </div>
        <div class="buttons">
            <button type="button" id="play">Play</button>
            <button type="button" id="stop">Stop</button>
            <button type="button" id="clear">Clear</button>
        </div>
        <div id="staves"></div>
    </body>
</html>