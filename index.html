<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Chord Dancer</title>
        <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
        <script>
            const {
                Renderer,
                Stave,
                StaveNote,
                Voice,
                Formatter,
                Accidental,
                BarNote,
                TextNote
            } = Vex.Flow;
            
            class ChordHistory extends EventTarget {
                #states = [];
                #currentIndex = -1;

                get #currentChords() {
                    return this.#states[this.#currentIndex] ?? [];
                }
                
                get latestChord() {
                    return this.#currentChords[this.#currentChords.length - 1];
                }

                #pushState(chords) {
                    this.#states = [
                        ...this.#states.slice(0, this.#currentIndex + 1),
                        chords
                    ];

                    this.#currentIndex = this.#states.length - 1;

                    this.dispatchEvent(new CustomEvent("stateUpdated"));
                }

                push(chord) {
                    this.#pushState([
                        ...this.#currentChords,
                        chord
                    ]);
                }

                clear() {
                    if (this.latestChord) this.#pushState([]);
                }

                #setOctave(octave) {
                    this.#pushState([
                        ...this.#currentChords.slice(0, -1),
                        [
                            ...this.latestChord.slice(0, -1),
                            octave
                        ]
                    ]);
                }

                increaseOctave() {
                    this.#setOctave(this.latestChord[3] + 1);
                }

                decreaseOctave() {
                    this.#setOctave(this.latestChord[3] - 1);
                }

                get canUndo() {
                    return this.#currentIndex > -1;
                }

                undo() {
                    if (this.canUndo) {
                        --this.#currentIndex;
                        this.dispatchEvent(new CustomEvent("stateUpdated"));
                    }
                }

                get canRedo() {
                    return this.#currentIndex < this.#states.length - 1;
                }

                redo() {
                    if (this.canRedo) {
                        ++this.#currentIndex;
                        this.dispatchEvent(new CustomEvent("stateUpdated"));
                    }
                }

                map(func) {
                    return this.#currentChords.map(func);
                }

                get length() {
                    return this.#currentChords.length;
                }
                
                getChord(index) {
                    return this.#currentChords[index];
                }
            }

            class ChordPlayer extends EventTarget {
                #audioCtx = new AudioContext();
                #wave = this.#audioCtx.createPeriodicWave([0, 1, 3], [2, 0, 3]);
                #gainEnvelope;
                static #chordLength = 1;

                stopChord() {
                    if(this.#gainEnvelope) {
                        this.#gainEnvelope.gain.linearRampToValueAtTime(0, this.#audioCtx.currentTime + 0.1);
                        this.#gainEnvelope = undefined;
                    }
                }

                #defaultStopPlayback = () => this.stopChord();
                #stopPlayback = this.#defaultStopPlayback;
                stopPlayback() {
                    this.#stopPlayback();
                }

                #playChord(root, third, fifth, octave, onEnded) {
                    this.stopChord();

                    const freqs = [
                        440 * Math.pow(2, (root - 9 + octave * 12) / 12),
                        440 * Math.pow(2, (root + third - 9 + octave * 12) / 12),
                        440 * Math.pow(2, (root + fifth - 9 + octave * 12) / 12)
                    ];

                    this.#gainEnvelope = new GainNode(this.#audioCtx);
                    this.#gainEnvelope.gain.setValueAtTime(0, this.#audioCtx.currentTime);
                    this.#gainEnvelope.gain.linearRampToValueAtTime(1 / freqs.length, this.#audioCtx.currentTime + 0.1);
                    this.#gainEnvelope.gain.linearRampToValueAtTime(0, this.#audioCtx.currentTime + ChordPlayer.#chordLength);

                    const oscs = [];

                    for (const freq of freqs) {
                        const osc = this.#audioCtx.createOscillator();
                        osc.setPeriodicWave(this.#wave);
                        osc.frequency.value = freq;
                        osc.connect(this.#gainEnvelope).connect(this.#audioCtx.destination);
                        oscs.push(osc);
                    }

                    for (const osc of oscs) {
                        osc.start();
                        osc.stop(this.#audioCtx.currentTime + ChordPlayer.#chordLength);
                    }

                    oscs[0].onended = onEnded;
                }

                playChord(root, third, fifth, octave) {
                    this.#playChord(root, third, fifth, octave);
                }
                        
                playChords(chords) {
                    this.#stopPlayback();

                    let stopSignalSent = false;
                    this.dispatchEvent(new CustomEvent("playbackStarted"));

                    this.#stopPlayback = function () {
                        this.#stopPlayback = this.#defaultStopPlayback;
                        this.#stopPlayback();
                        stopSignalSent = true;
                        this.dispatchEvent(new CustomEvent("playbackEnded"));
                    }

                    const thisPlayer = this;

                    function playIndex(index) {
                        if (stopSignalSent == false) {

                            if (index < chords.length) {
                                thisPlayer.dispatchEvent(new CustomEvent("chordStarted", { detail: { index } }));
                                thisPlayer.#playChord(
                                    ...chords.getChord(index),
                                    () => {
                                        thisPlayer.dispatchEvent(new CustomEvent("chordEnded", { detail: { index } }));
                                        playIndex(index + 1);
                                    }
                                );
                            } else {
                                thisPlayer.dispatchEvent(new CustomEvent("playbackEnded"));
                            }
                        }
                    }

                    playIndex(0);
                }
            }

            class ChordHelper {
                static noteNames = Object.freeze(["C", "Câ™¯", "D", "Dâ™¯", "E", "F", "Fâ™¯", "G", "Gâ™¯", "A", "Aâ™¯", "B"]);

                static thirdNames= Object.freeze({
                    2: "sus2",
                    3: "min",
                    4: "maj",
                    5: "sus4"
                });

                static fifthNames = Object.freeze({
                    5: "ð„«5",
                    6: "â™­5",
                    7: "5",
                    8: "â™¯5"
                });

                static octaveNames =  Object.freeze(["-3", "-2", "-1", "+0", "+1", "+2", "+3"]);

                static thirds = Object.freeze({
                    "sus2": 2,
                    "min": 3,
                    "maj": 4,
                    "sus4": 5
                });

                static fifths = Object.freeze({
                    "perf4": 5,
                    "dim": 6,
                    "perf": 7,
                    "aug": 8
                });

                static chordNames =  Object.freeze({
                    [ChordHelper.thirds.sus2]: Object.freeze({
                        [ChordHelper.fifths.perf4]: "sus2ð„«5",
                        [ChordHelper.fifths.dim]: "sus2â™­5",
                        [ChordHelper.fifths.perf]: "sus2",
                        [ChordHelper.fifths.aug]: "sus2â™¯5"
                    }),
                    [ChordHelper.thirds.min]: Object.freeze({
                        [ChordHelper.fifths.perf4]: "minð„«5",
                        [ChordHelper.fifths.dim]: "dim",
                        [ChordHelper.fifths.perf]: "min",
                        [ChordHelper.fifths.aug]: "minâ™¯5"
                    }),
                    [ChordHelper.thirds.maj]: Object.freeze({
                        [ChordHelper.fifths.perf4]: "majð„«5",
                        [ChordHelper.fifths.dim]: "majâ™­5",
                        [ChordHelper.fifths.perf]: "maj",
                        [ChordHelper.fifths.aug]: "aug"
                    }),
                    [ChordHelper.thirds.sus4]: Object.freeze({
                        [ChordHelper.fifths.dim]: "sus4â™­5",
                        [ChordHelper.fifths.perf]: "sus4",
                        [ChordHelper.fifths.aug]: "sus4â™¯5"
                    })
                });

                static nameChord = function(root, third, fifth) {
                    const rootName = ChordHelper.noteNames[root];
                    const chordName = ChordHelper.chordNames[third]?.[fifth];
                    return (rootName && chordName)
                        ? `${rootName}${chordName}`
                        : undefined;
                };
            
                static spellChord = function(root, third, fifth) {
                    const rootName = ChordHelper.noteNames[root];
                    const thirdName = ChordHelper.noteNames[(root + third) % 12];
                    const fifthName = ChordHelper.noteNames[(root + fifth) % 12];
                    return (rootName && thirdName && fifthName)
                        ? `${rootName} ${thirdName} ${fifthName}`
                        : undefined;
                };

                static lowerRoot = function(root, third, fifth) {
                    return [
                        (root - 1 + 12) % 12,
                        (third + 1) % 12,
                        (fifth + 1) % 12
                    ];
                };
                
                static raiseRoot = function(root, third, fifth) {
                    return [
                        (root + 1) % 12,
                        (third - 1 + 12) % 12,
                        (fifth - 1 + 12) % 12
                    ];
                };
                
                static lowerThird = function(root, third, fifth) {
                    return [
                        root,
                        (third - 1 + 12) % 12,
                        fifth
                    ];
                };
                
                static raiseThird(root, third, fifth) {
                    return [
                        root,
                        (third + 1) % 12,
                        fifth
                    ];
                }
                
                static lowerFifth(root, third, fifth) {
                    return [
                        root,
                        third,
                        (fifth - 1 + 12) % 12
                    ];
                }
                
                static raiseFifth(root, third, fifth) {
                    return [
                        root,
                        third,
                        (fifth + 1) % 12
                    ];
                }
                
                static findRootPosition(root, third, fifth) {
                    return (root !== undefined && ChordHelper.chordNames[third]?.[fifth])
                        ? [root, third, fifth]
                        : undefined;
                }

                static findFirstInversion(root, third, fifth) {
                    const newRoot = (root + third) % 12;
                    const newThird = (12 + fifth - third) % 12;
                    const newFifth = (12 - third) % 12;

                    return (newRoot !== undefined && ChordHelper.chordNames[newThird]?.[newFifth])
                        ? [newRoot, newThird, newFifth]
                        : undefined;
                }

                static findSecondInversion(root, third, fifth) {
                    const newRoot = (root + fifth) % 12;
                    const newThird = (12 - fifth) % 12;
                    const newFifth = (12 + third - fifth) % 12;

                    return (newRoot !== undefined && ChordHelper.chordNames[newThird]?.[newFifth])
                        ? [newRoot, newThird, newFifth]
                        : undefined;
                }

                static findInversions(root, third, fifth) {
                    const rootPosition = ChordHelper.findRootPosition(root, third, fifth);
                    const firstInversion = ChordHelper.findFirstInversion(root, third, fifth);
                    const secondInversation = ChordHelper.findSecondInversion(root, third, fifth);

                    const inversions = [];
                    if (rootPosition) inversions.push(rootPosition);
                    if (firstInversion) inversions.push(firstInversion);
                    if (secondInversation) inversions.push(secondInversation);
                    return inversions;
                }
            };

            class StaveHelper {
                static metrics = Object.freeze({
                    chordWidth: 150,
                    clefWidth: 50,
                    staveHeight: 130,
                    topMargin: 30,
                    horizontalMargin: 20,
                    maxChords: 6
                });

                static noteNames = Object.freeze(["c", "c#", "d", "d#", "e", "f", "f#", "g", "g#", "a", "a#", "b"]);

                static createChord(root, third, fifth, octave) {
                    const position = 4 + octave;
                    const keys = [
                        `${StaveHelper.noteNames[root]}/${position}`,
                        `${StaveHelper.noteNames[(root + third) % 12]}/${position + Math.floor((root + third) / 12)}`,
                        `${StaveHelper.noteNames[(root + fifth) % 12]}/${position + Math.floor((root + fifth) / 12)}`
                    ];

                    const chord =  new StaveNote(
                        {
                            keys,
                            duration: "w"
                        }
                    );

                    for (const index in keys) {
                        if (keys[index].includes("#")) {
                            chord.addModifier(new Accidental("#"), parseInt(index))
                        }
                    }

                    return chord;
                }

                static nameChord(root, third, fifth) {
                    return new TextNote({
                        text: ChordHelper.nameChord(root, third, fifth),
                        duration: "w",
                        font: {
                            family: "system-ui",
                            size: 15,
                            weight: ""
                        },
                        justification: TextNote.Justification.LEFT,
                        line: 0
                    });
                }
            }

            customElements.define("chord-picker", class extends HTMLElement {
                rootPicker;
                thirdPicker;
                fifthPicker;
                octavePicker;
                button;

                static observedAttributes = ["root", "third", "fifth", "octave"];
                
                constructor() {
                    super();

                    const picker = this.attachShadow({ mode: "closed" });

                    {
                        this.rootPicker = document.createElement("select");
                        this.rootPicker.setAttribute("part", "control select");
                        this.rootPicker.addEventListener("change", () => this.updateButton());

                        for (const index in ChordHelper.noteNames) {
                            const option = document.createElement("option");
                            option.setAttribute("value", index);
                            option.innerText = ChordHelper.noteNames[index];
                            this.rootPicker.appendChild(option);
                        }

                        picker.appendChild(this.rootPicker);
                    }
 
                    {
                        this.thirdPicker = document.createElement("select");
                        this.thirdPicker.setAttribute("part", "control select");
                        this.thirdPicker.addEventListener("change", () => this.updateButton());

                        for (const index in ChordHelper.thirdNames) {
                            const option = document.createElement("option");
                            option.setAttribute("value", index);
                            option.innerText = ChordHelper.thirdNames[index];
                            this.thirdPicker.appendChild(option);
                        }

                        picker.appendChild(this.thirdPicker);
                    }

                    {
                        this.fifthPicker = document.createElement("select");
                        this.fifthPicker.setAttribute("part", "control select");
                        this.fifthPicker.addEventListener("change", () => this.updateButton());

                        for (const index in ChordHelper.fifthNames) {
                            const option = document.createElement("option");
                            option.setAttribute("value", index);
                            option.innerText = ChordHelper.fifthNames[index];
                            this.fifthPicker.appendChild(option);
                            
                        }

                        picker.appendChild(this.fifthPicker);
                    }

                    {
                        this.octavePicker = document.createElement("select");
                        this.octavePicker.setAttribute("part", "control select");
                        for (const name of ChordHelper.octaveNames.toReversed()) {
                            const index = parseInt(name);
                            const option = document.createElement("option");
                            option.setAttribute("value", index);
                            option.innerText = name;
                            this.octavePicker.appendChild(option);
                        }
                        picker.appendChild(this.octavePicker);
                    }

                    {
                        this.button = document.createElement("button");
                        this.button.setAttribute("part", "control button");
                        this.button.addEventListener("click", () => {
                            this.dispatchEvent(new CustomEvent(
                                "chordPushed",
                                {
                                    bubbles: true,
                                    detail: [
                                        parseInt(this.rootPicker.value),
                                        parseInt(this.thirdPicker.value),
                                        parseInt(this.fifthPicker.value),
                                        parseInt(this.octavePicker.value)
                                    ]
                                }
                            ));
                        });
                        picker.appendChild(this.button);
                    }
                }

                updateButton() {
                    const root = this.rootPicker.value;
                    const third = this.thirdPicker.value;
                    const fifth = this.fifthPicker.value;
                    const octave = this.octavePicker.value;
                    const chordName = ChordHelper.nameChord(root, third, fifth);
                    const chordSpelling = ChordHelper.spellChord(root, third, fifth);
                    if (chordName) {
                        this.button.innerText = `${chordName} (${chordSpelling})`;
                        this.button.disabled = false;
                    } else {
                        this.button.innerText = "Chord undefined";
                        this.button.disabled = true;
                    }
                }

                attributeChangedCallback(name, oldValue, newValue) {
                    if (oldValue === newValue) return;

                    if (name === "root") this.rootPicker.value = newValue;
                    if (name === "third") this.thirdPicker.value = newValue;
                    if (name === "fifth") this.fifthPicker.value = newValue;
                    if (name === "octave") this.octavePicker.value = newValue;
                    this.updateButton();
                }
            });

            customElements.define("chord-button", class extends HTMLElement {
                root;
                third;
                fifth;
                octave;

                chord;
                button;

                static observedAttributes = ["root", "third", "fifth", "octave"];

                constructor() {
                    super();

                    this.chord = this.attachShadow({ mode: "closed" });
                    
                    this.button = document.createElement("button");
                    this.button.setAttribute("type", "button");
                    this.button.setAttribute("part", "button");
                    this.button.addEventListener("click", () => {
                        this.dispatchEvent(new CustomEvent(
                            "chordPushed",
                            {
                                bubbles: true,
                                detail: [
                                    this.root,
                                    this.third,
                                    this.fifth,
                                    this.octave
                                ]
                            }
                        ));
                    });
                }

                updateButton() {
                    const chordName = ChordHelper.nameChord(this.root, this.third, this.fifth);
                    const chordSpelling = ChordHelper.spellChord(this.root, this.third, this.fifth);
                    this.button.innerText = `${chordName} (${chordSpelling})`;
                    if (chordName) {
                        this.chord.appendChild(this.button);
                    } else if (this.chord.contains(this.button)) {
                        this.chord.removeChild(this.button);
                    }
                }

                attributeChangedCallback(name, oldValue, newValue) {
                    if (oldValue === newValue) return;

                    if (name === "root") this.root = parseInt(newValue);
                    if (name === "third") this.third = parseInt(newValue);
                    if (name === "fifth") this.fifth = parseInt(newValue);
                    if (name === "octave") this.octave = parseInt(newValue);
                    this.updateButton();
                }
            });

            customElements.define("chord-collection", class extends HTMLElement {
                root;
                third;
                fifth;
                octave;

                collection;
                firstChord;
                secondChord;
                thirdChord;

                static observedAttributes = ["root", "third", "fifth", "octave"];

                constructor() {
                    super();

                    this.collection = this.attachShadow({ mode: "closed" });

                    this.firstChord = document.createElement("chord-button");
                    this.firstChord.setAttribute("exportparts", "button");
                    this.firstChord.setAttribute("part", "chord");
                    this.firstChord.addEventListener("chordPushed", e => this.pushChord(e));
                    this.secondChord = document.createElement("chord-button");
                    this.secondChord.setAttribute("exportparts", "button");
                    this.secondChord.setAttribute("part", "chord");
                    this.secondChord.addEventListener("chordPushed", e => this.pushChord(e));
                    this.thirdChord = document.createElement("chord-button");
                    this.thirdChord.setAttribute("exportparts", "button");
                    this.thirdChord.setAttribute("part", "chord");
                    this.thirdChord.addEventListener("chordPushed", e => this.pushChord(e));
                }

                pushChord(e) {
                    this.dispatchEvent(new CustomEvent(
                        "chordPushed",
                        {
                            bubbles: true,
                            detail: e.detail
                        }
                    ));
                }

                attributeChangedCallback(name, oldValue, newValue) {
                    if (oldValue === newValue) return;

                    if (name === "root") {
                        this.root = parseInt(newValue);
                        this.updateChords();
                    }
                    if (name === "third") {
                        this.third = parseInt(newValue);
                        this.updateChords();
                    }
                    if (name === "fifth") {
                        this.fifth = parseInt(newValue);
                        this.updateChords();
                    }
                    if (name === "octave") {
                        this.octave = parseInt(newValue);
                        this.updateOctave();
                    }
                }

                updateChords() {
                    const inversions = ChordHelper.findInversions(this.root, this.third, this.fifth);

                    if (inversions[0]) {
                        this.firstChord.setAttribute("root", inversions[0][0]);
                        this.firstChord.setAttribute("third", inversions[0][1]);
                        this.firstChord.setAttribute("fifth", inversions[0][2]);
                        this.collection.appendChild(this.firstChord);
                    } else if (this.collection.contains(this.firstChord)) {
                        this.collection.removeChild(this.firstChord);
                    }

                    if (inversions[1]) {
                        this.secondChord.setAttribute("root", inversions[1]?.[0]);
                        this.secondChord.setAttribute("third", inversions[1]?.[1]);
                        this.secondChord.setAttribute("fifth", inversions[1]?.[2]);
                        this.collection.appendChild(this.secondChord);
                    } else if (this.collection.contains(this.secondChord)) {
                        this.collection.removeChild(this.secondChord);
                    }

                    if (inversions[2]) {
                        this.thirdChord.setAttribute("root", inversions[2]?.[0]);
                        this.thirdChord.setAttribute("third", inversions[2]?.[1]);
                        this.thirdChord.setAttribute("fifth", inversions[2]?.[2]);
                        this.collection.appendChild(this.thirdChord);
                    } else if (this.collection.contains(this.thirdChord)) {
                        this.collection.removeChild(this.thirdChord);
                    }
                }

                updateOctave() {
                    this.firstChord.setAttribute("octave", this.octave);
                    this.secondChord.setAttribute("octave", this.octave);
                    this.thirdChord.setAttribute("octave", this.octave);
                }
            });

            customElements.define("octave-control", class extends HTMLElement {
                octave;
                disabled;

                upButton;
                downButton;

                static observedAttributes = ["octave", "disabled"];

                constructor() {
                    super();

                    const control = this.attachShadow({ mode: "closed" });

                    this.upButton = document.createElement("button");
                    this.upButton.setAttribute("part", "button");
                    this.upButton.innerText = "Octave Up";
                    this.upButton.addEventListener("click", () => {
                        this.dispatchEvent(new CustomEvent(
                            "octaveIncreased",
                            {
                                bubbles: true
                            }
                        ));
                    });
                    control.appendChild(this.upButton);

                    this.downButton = document.createElement("button");
                    this.downButton.setAttribute("part", "button");
                    this.downButton.innerText = "Octave Down";
                    this.downButton.addEventListener("click", () => {
                        this.dispatchEvent(new CustomEvent(
                            "octaveDecreased",
                            {
                                bubbles: true
                            }
                        ));
                    });
                    control.appendChild(this.downButton);
                }

                attributeChangedCallback(name, oldValue, newValue) {
                    if (oldValue === newValue) return;

                    if (name === "octave") {
                        this.octave = parseInt(newValue);
                        this.updateOctave();
                    }

                    if (name === "disabled") {
                        this.disabled = newValue != null;
                        this.updateOctave();
                    }
                }

                updateOctave() {
                    this.downButton.disabled = this.disabled || this.octave <= -3;
                    this.upButton.disabled = this.disabled || this.octave >= 3;
                }
            });

            customElements.define("chord-graph", class extends HTMLElement {
                root;
                third;
                fifth;
                octave;
                activeChord;

                currentChordCollection;
                raiseRootCollection;
                lowerRootCollection;
                raiseThirdCollection;
                lowerThirdCollection;
                raiseFifthCollection;
                lowerFifthCollection;

                octaveControl;

                static observedAttributes = ["root", "third", "fifth", "octave", "active-chord"];

                constructor() {
                    super();

                    const root = this.attachShadow({ mode: "closed" });
                    root.addEventListener("chordPushed", (e) =>  this.dispatchEvent(new CustomEvent(
                        "chordPushed",
                        {
                            bubbles: true,
                            detail: e.detail
                        }
                    )));
                    root.addEventListener("octaveIncreased", () => this.dispatchEvent(new CustomEvent(
                        "octaveIncreased",
                        {
                            bubbles: true
                        }
                    )));
                    root.addEventListener("octaveDecreased", () => this.dispatchEvent(new CustomEvent(
                        "octaveDecreased",
                        {
                            bubbles: true
                        }
                    )));

                    const table = document.createElement("div");
                    table.setAttribute("part", "table");

                    const octaveControlParts = "octave-control cell";
                    const octaveControlExportedParts = "button, button:octave-button";
                    const chordCollectionParts = "chord-collection cell"
                    const chordCollectionExportedParts = "button, button:chord-button";

                    const topRow = document.createElement("div");
                    topRow.setAttribute("part", "row");
                    const placeholder = document.createElement("div");
                    placeholder.setAttribute("part", "cell");
                    this.raiseRootCollection = document.createElement("chord-collection");
                    this.raiseRootCollection.setAttribute("exportparts", chordCollectionExportedParts);
                    this.raiseRootCollection.setAttribute("part", chordCollectionParts);
                    this.raiseThirdCollection = document.createElement("chord-collection");
                    this.raiseThirdCollection.setAttribute("exportparts", chordCollectionExportedParts);
                    this.raiseThirdCollection.setAttribute("part", chordCollectionParts);
                    topRow.append(
                        placeholder,
                        this.raiseRootCollection,
                        this.raiseThirdCollection
                    );

                    const middleRow = document.createElement("div");
                    middleRow.setAttribute("part", "row");
                    this.lowerFifthCollection = document.createElement("chord-collection");
                    this.lowerFifthCollection.setAttribute("exportparts", chordCollectionExportedParts);
                    this.lowerFifthCollection.setAttribute("part", chordCollectionParts);
                    this.currentChordCollection = document.createElement("chord-collection");
                    this.currentChordCollection.setAttribute("exportparts", chordCollectionExportedParts);
                    this.currentChordCollection.setAttribute("part", chordCollectionParts);
                    this.raiseFifthCollection = document.createElement("chord-collection");
                    this.raiseFifthCollection.setAttribute("exportparts", chordCollectionExportedParts);
                    this.raiseFifthCollection.setAttribute("part", chordCollectionParts);
                    middleRow.append(
                        this.lowerFifthCollection,
                        this.currentChordCollection,
                        this.raiseFifthCollection
                    );
                    
                    const bottomRow = document.createElement("div");
                    bottomRow.setAttribute("part", "row");
                    this.lowerThirdCollection = document.createElement("chord-collection");
                    this.lowerThirdCollection.setAttribute("exportparts", chordCollectionExportedParts);
                    this.lowerThirdCollection.setAttribute("part", chordCollectionParts);
                    this.lowerRootCollection = document.createElement("chord-collection");
                    this.lowerRootCollection.setAttribute("exportparts", chordCollectionExportedParts);
                    this.lowerRootCollection.setAttribute("part", chordCollectionParts);
                    this.octaveControl = document.createElement("octave-control");
                    this.octaveControl.setAttribute("exportparts", octaveControlExportedParts);
                    this.octaveControl.setAttribute("part", octaveControlParts);
                    bottomRow.append(
                        this.lowerThirdCollection,
                        this.lowerRootCollection,
                        this.octaveControl
                    );

                    table.append(topRow, middleRow, bottomRow);
                    root.append(table);
                }
                
                attributeChangedCallback(name, oldValue, newValue) {
                    if (oldValue === newValue) return;

                    if (name === "root") {
                        this.root = parseInt(newValue);
                        this.updateChordCollections();
                    }
                    if (name === "third") {
                        this.third = parseInt(newValue);
                        this.updateChordCollections();
                    }
                    if (name === "fifth") {
                        this.fifth = parseInt(newValue);
                        this.updateChordCollections();
                    }
                    if (name === "octave") {
                        this.octave = parseInt(newValue);
                        this.updateChordCollections();
                        this.updateOctave();
                    }
                    if (name === "active-chord") {
                        this.activeChord = newValue != null;
                        this.updateOctave();
                    }
                }

                updateChordCollection(chordCollection, root, third, fifth, octave) {
                    chordCollection.setAttribute("root", root);
                    chordCollection.setAttribute("third", third);
                    chordCollection.setAttribute("fifth", fifth);
                    chordCollection.setAttribute("octave", octave);
                }

                updateChordCollections() {
                    this.updateChordCollection(this.raiseRootCollection, ...ChordHelper.raiseRoot(this.root, this.third, this.fifth), this.octave);
                    this.updateChordCollection(this.raiseThirdCollection, ...ChordHelper.raiseThird(this.root, this.third, this.fifth), this.octave);
                    this.updateChordCollection(this.lowerFifthCollection, ...ChordHelper.lowerFifth(this.root, this.third, this.fifth), this.octave);
                    this.updateChordCollection(this.currentChordCollection, this.root, this.third, this.fifth, this.octave);
                    this.updateChordCollection(this.raiseFifthCollection, ...ChordHelper.raiseFifth(this.root, this.third, this.fifth), this.octave);
                    this.updateChordCollection(this.lowerThirdCollection, ...ChordHelper.lowerThird(this.root, this.third, this.fifth), this.octave);
                    this.updateChordCollection(this.lowerRootCollection, ...ChordHelper.lowerRoot(this.root, this.third, this.fifth), this.octave);
                }

                updateOctave() {
                    if (this.activeChord) {
                        this.octaveControl.removeAttribute("disabled");
                    } else {
                        this.octaveControl.setAttribute("disabled", "");
                    }
                    this.octaveControl.setAttribute("octave", this.octave);
                }
            });
            
            customElements.define("chord-sheet", class extends HTMLElement {
                #container;
                #width = 0;

                constructor() {
                    super();

                    const root = this.attachShadow({ mode: "closed" });
                    const style = new CSSStyleSheet();
                    style.insertRule(`div {
                        display: flex;
                        justify-content: center;
                        width: 100% !important;
                    }`);
                    style.insertRule(`.vf-stavenote.selected:not(.playing) {
                        fill: var(--selected-color);

                        & + text {
                            fill: var(--selected-text-color);
                        }
                    }`);
                    style.insertRule(`.vf-stavenote.playing {
                        fill: var(--playing-color);

                        & + text {
                            fill: var(--playing-text-color);
                        }
                    }`);
                    root.adoptedStyleSheets = [style];
                    this.#container = document.createElement("div");
                    root.appendChild(this.#container);

                    const resizeObserver = new ResizeObserver((entries) => {
                        this.#width = entries[0].contentBoxSize[0].inlineSize;
                        this.#render();
                    });

                    resizeObserver.observe(this);
                }

                #chords = [];

                set chords(newChords) {
                    this.#chords = newChords;
                    this.#render();
                }

                get #staveWidth() {
                    return this.#width - StaveHelper.metrics.horizontalMargin * 2;
                }

                playChord(index) {
                    this.#container.querySelectorAll(".vf-stavenote")?.[index]?.classList.add("playing");
                }

                stopChord(index) {
                    this.#container.querySelectorAll(".vf-stavenote")?.[index]?.classList.remove("playing");
                }

                stopPlayback() {
                    this.#container.querySelectorAll(".vf-stavenote.playing")?.forEach(chord => chord.classList.remove("playing"));
                }

                selectChord(index) {
                    this.#container.querySelectorAll(".vf-stavenote")?.[index]?.classList.add("selected");
                }

                deselectChord(index) {
                    this.#container.querySelectorAll(".vf-stavenote")?.[index]?.classList.remove("selected");
                }

                clearSelection() {
                    this.#container.querySelectorAll(".vf-stavenote.selected")?.forEach(chord => chord.classList.remove("selected"));
                }

                #render() {
                    const notes = this.#chords.map(chord => StaveHelper.createChord(...chord));
                    const chordNames = this.#chords.map(chord => StaveHelper.nameChord(...chord));
                    
                    const maxChords = Math.floor((this.#staveWidth) / StaveHelper.metrics.chordWidth);
                    const staveCount = Math.max(1, Math.ceil(notes.length / maxChords));

                    this.#container.textContent = "";
                    const renderer = new Renderer(this.#container, Renderer.Backends.SVG);
                    const canvasWidth = this.#width;
                    const canvasHeight = StaveHelper.metrics.topMargin + staveCount * StaveHelper.metrics.staveHeight;
                    renderer.resize(canvasWidth, canvasHeight);
                    const context = renderer.getContext();

                    for (let staveIndex = 0; staveIndex < staveCount || staveIndex === 0; ++staveIndex) {
                        const staveNotes = notes.slice(staveIndex * maxChords, (staveIndex + 1) * maxChords);
                        const staveChordNames = chordNames.slice(staveIndex * maxChords, (staveIndex + 1) * maxChords);
                        const top = StaveHelper.metrics.topMargin + staveIndex * (StaveHelper.metrics.staveHeight);
                        this.#renderStave(staveNotes, staveChordNames, context, top);
                    }
                }

                #renderStave(notes, chordNames, context, top) {
                    const noteWidth = (this.#staveWidth - StaveHelper.metrics.clefWidth) / notes.length;
                    for (const noteIndex in notes) {
                        const measureWidth = noteWidth;
                        const leftEdge =
                            StaveHelper.metrics.horizontalMargin
                            + noteWidth * noteIndex;
                        const stave = new Stave(leftEdge, top, measureWidth);
                        stave.setContext(context);
                        if (noteIndex === "0") {
                            stave.addClef("treble");
                        }

                        const voice = new Voice({ num_beats: 1, beat_value: 1 }).setContext(context);
                        voice.addTickables([notes[noteIndex]]).setStave(stave);

                        const chordNameVoice = new Voice({ num_beats: 1, beat_value: 1 }).setContext(context);
                        chordNames[noteIndex].setStave(stave);
                        chordNameVoice.addTickables([chordNames[noteIndex]]).setStave(stave);

                        new Formatter().joinVoices([voice, chordNameVoice]).formatToStave([voice, chordNameVoice], stave);
                        stave.draw();
                        voice.draw();
                        chordNameVoice.draw();
                    }
                }
            });

            document.addEventListener("DOMContentLoaded", () => {
                const chordHistory = new ChordHistory();
                const chordPlayer = new ChordPlayer();
                const chordGraph = document.querySelector("chord-graph");
                const chordPicker = document.querySelector("chord-picker");
                const chordSheet = document.querySelector("chord-sheet");

                chordHistory.addEventListener("stateUpdated", updateUI);

                chordPlayer.addEventListener("chordStarted", (event) => {
                    chordSheet.playChord(event.detail.index);
                });
                chordPlayer.addEventListener("chordEnded", (event) => {
                    chordSheet.stopChord(event.detail.index);
                });
                chordPlayer.addEventListener("playbackStarted", () => {
                    document.getElementById("stop").disabled = false;
                });
                chordPlayer.addEventListener("playbackEnded", () => {
                    document.getElementById("stop").disabled = true;
                    chordSheet.stopPlayback();
                });

                document.addEventListener("chordPushed", () => chordHistory.push(event.detail));
                document.addEventListener("octaveIncreased", () => chordHistory.increaseOctave());
                document.addEventListener("octaveDecreased", () => chordHistory.decreaseOctave());

                document.getElementById("clear").addEventListener("click", () => chordHistory.clear());
                document.getElementById("undo").addEventListener("click", () => chordHistory.undo());
                document.getElementById("redo").addEventListener("click", () => chordHistory.redo());

                document.getElementById("play").addEventListener("click", () => chordPlayer.playChords(chordHistory));
                document.getElementById("stop").addEventListener("click", () => chordPlayer.stopPlayback());

                function updateUI() {
                    function setChord(root, third, fifth, octave) {
                        chordGraph.setAttribute("root", root);
                        chordGraph.setAttribute("third", third);
                        chordGraph.setAttribute("fifth", fifth);
                        chordGraph.setAttribute("octave", octave);

                        chordPicker.setAttribute("root", root);
                        chordPicker.setAttribute("third", third);
                        chordPicker.setAttribute("fifth", fifth);
                        chordPicker.setAttribute("octave", octave);
                    }

                    chordPlayer.stopPlayback();
                    document.getElementById("stop").disabled = true;

                    if (chordHistory.latestChord) {
                        setChord(...chordHistory.latestChord);
                        chordGraph.setAttribute("active-chord", "");
                        chordPlayer.playChord(...chordHistory.latestChord);
                        document.getElementById("clear").disabled = false;
                        document.getElementById("play").disabled = false;
                    } else {
                        setChord(0, ChordHelper.thirds.maj, ChordHelper.fifths.perf, 0);
                        chordGraph.removeAttribute("active-chord");
                        document.getElementById("clear").disabled = true;
                        document.getElementById("play").disabled = true;
                    }

                    document.getElementById("undo").disabled = !chordHistory.canUndo;
                    document.getElementById("redo").disabled = !chordHistory.canRedo;
                    
                    chordSheet.chords = chordHistory;
                }

                updateUI();
            });
        </script>

        <style>
            html {
                font-family: system-ui;
                --theme-color: yellow;
                --border-radius: 0.4em;
                --chord-width: 11em;
            }

            body {
                display: flex;
                font-size: 1.2rem;
                flex-direction: column;
                align-items: center;
            }

            h1 {
                color: oklch(from var(--theme-color) 65% 20% h);
            }

            .buttons, chord-picker {
                margin: 1em 0;
            }

            chord-sheet {
                width: 100%;
                --playing-color: oklch(from var(--theme-color) 60% 30% h);
                --playing-text-color: oklch(from var(--theme-color) 50% 50% h);
                --selected-color: oklch(from var(--theme-color) 60% 30% h);
                --selected-text-color: oklch(from var(--theme-color) 50% 50% h);
            }

            chord-graph {
                &::part(table) {
                    display: table;
                    border-spacing: 0.75em;
                }

                &::part(row) {
                    display: table-row;
                }

                &::part(cell) {
                    display: table-cell;
                    vertical-align: middle;
                    width: var(--chord-width);
                    height: 6em;
                }

                &::part(chord-collection) {
                    border: 0.15em solid oklch(from var(--theme-color) 80% 20% h);
                    border-radius: var(--border-radius);
                    background: oklch(from var(--theme-color) 98% 2% h);
                    padding: 0 0.25em;
                }
            }

            button,
            chord-picker::part(control) {
                margin: 0 0.4em;
            }

            chord-picker::part(button) {
                width: var(--chord-width);
                line-height: 1.2em;
            }

            button,
            chord-picker::part(control),
            chord-graph::part(octave-button) {
                border: 0.15em solid oklch(from var(--theme-color) 80% 20% h);
                background: oklch(from var(--theme-color) 98% 2% h);
            }

            button,
            chord-picker::part(control),
            chord-graph::part(button) {
                color: oklch(from var(--theme-color) 30% 30% h);
                border-radius: var(--border-radius);
                padding: 0.25em 0.4em;
                font-size: 1em;
            }

            chord-graph::part(button) {
                margin: 0.25em 0;
                width: 100%;
            }

            chord-graph::part(chord-button) {
                border: 0;
                line-height: 0.9em;
                text-align: left;
                cursor: pointer;
                background: transparent;
            }

            /* Pseudo-elements and nesting/is don't get along: https://github.com/w3c/csswg-drafts/issues/9702 */
            button:focus:not(:hover, :active, :disabled),
            chord-picker::part(control):focus:not(:hover, :active, :disabled),
            chord-graph::part(button):focus:not(:hover, :active, :disabled)
            {
                background: oklch(from var(--theme-color) 94% 10% h);
            }

            button:hover:not(:active, :disabled),
            chord-picker::part(control):hover:not(:active, :disabled),
            chord-graph::part(button):hover:not(:active, :disabled)
            {
                background: oklch(from var(--theme-color) 90% 10% h);
            }

            button:active:not(:disabled),
            chord-picker::part(button):active:not(:disabled),
            chord-graph::part(button):active:not(:disabled)
            {
                background: oklch(from var(--theme-color) 94% 10% h);
            }

            button:disabled,
            chord-graph::part(octave-button):disabled {
                color: oklch(from var(--theme-color) 80% 10% h);
                border-color: oklch(from var(--theme-color) 90% 10% h);
                background: oklch(from var(--theme-color) 95% 2% h);
            }
        </style>
    </head>
    <body>
        <h1>Chord Dancer</h1>
        <chord-picker></chord-picker>
        <chord-graph></chord-graph>
        <div class="buttons">
            <button type="button" id="undo">Undo</button>
            <button type="button" id="redo">Redo</button>
        </div>
        <div class="buttons">
            <button type="button" id="play">Play</button>
            <button type="button" id="stop">Stop</button>
            <button type="button" id="clear">Clear</button>
        </div>
        <chord-sheet></chord-sheet>
    </body>
</html>