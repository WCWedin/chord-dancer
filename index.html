<!DOCTYPE html>
<html>
    <head>
        <title>Chord Dancer</title>
        <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
        <script>
            const {
                Renderer,
                Stave,
                StaveNote,
                Voice,
                Formatter,
                Accidental,
                BarNote,
                TextNote
            } = Vex.Flow;

            class ChordHistory extends EventTarget {
                #states = [];
                #currentIndex = -1;

                get #currentChords() {
                    return this.#states[this.#currentIndex] ?? [];
                }
                
                get latestChord() {
                    return this.#currentChords[this.#currentChords.length - 1];
                }

                #pushState(chords) {
                    this.#states = [
                        ...this.#states.slice(0, this.#currentIndex + 1),
                        chords
                    ];

                    this.#currentIndex = this.#states.length - 1;

                    this.dispatchEvent(new CustomEvent("stateUpdated"));
                }

                push(chord) {
                    this.#pushState([
                        ...this.#currentChords,
                        chord
                    ]);
                }

                clear() {
                    if (this.latestChord) this.#pushState([]);
                }

                #setOctave(octave) {
                    this.#pushState([
                        ...this.#currentChords.slice(0, -1),
                        [
                            ...this.latestChord.slice(0, -1),
                            octave
                        ]
                    ]);
                }

                increaseOctave() {
                    this.#setOctave(this.latestChord[3] + 1);
                }

                decreaseOctave() {
                    this.#setOctave(this.latestChord[3] - 1);
                }

                get canUndo() {
                    return this.#currentIndex > -1;
                }

                undo() {
                    if (this.canUndo) {
                        --this.#currentIndex;
                        this.dispatchEvent(new CustomEvent("stateUpdated"));
                    }
                }

                get canRedo() {
                    return this.#currentIndex < this.#states.length - 1;
                }

                redo() {
                    if (this.canRedo) {
                        ++this.#currentIndex;
                        this.dispatchEvent(new CustomEvent("stateUpdated"));
                    }
                }

                map(func) {
                    return this.#currentChords.map(func);
                }

                get length() {
                    return this.#currentChords.length;
                }
                
                getChord(index) {
                    return this.#currentChords[index];
                }
            }

            class ChordPlayer extends EventTarget {
                #audioCtx = new AudioContext();
                #wave = this.#audioCtx.createPeriodicWave([0, 1, 3], [2, 0, 3]);
                #gainEnvelope;
                static #chordLength = 1;

                stopChord() {
                    if(this.#gainEnvelope) {
                        this.#gainEnvelope.gain.linearRampToValueAtTime(0, this.#audioCtx.currentTime + 0.1);
                        this.#gainEnvelope = undefined;
                    }
                }

                #defaultStopPlayback = () => this.stopChord();
                #stopPlayback = this.#defaultStopPlayback;
                stopPlayback() {
                    this.#stopPlayback();
                }

                #playChord(root, third, fifth, octave, onEnded) {
                    this.stopChord();

                    const freqs = [
                        440 * Math.pow(2, (root - 9 + octave * 12) / 12),
                        440 * Math.pow(2, (root + third - 9 + octave * 12) / 12),
                        440 * Math.pow(2, (root + fifth - 9 + octave * 12) / 12)
                    ];

                    this.#gainEnvelope = new GainNode(this.#audioCtx);
                    this.#gainEnvelope.gain.setValueAtTime(0, this.#audioCtx.currentTime);
                    this.#gainEnvelope.gain.linearRampToValueAtTime(1 / freqs.length, this.#audioCtx.currentTime + 0.1);
                    this.#gainEnvelope.gain.linearRampToValueAtTime(0, this.#audioCtx.currentTime + ChordPlayer.#chordLength);

                    const oscs = [];

                    for (const freq of freqs) {
                        const osc = this.#audioCtx.createOscillator();
                        osc.setPeriodicWave(this.#wave);
                        osc.frequency.value = freq;
                        osc.connect(this.#gainEnvelope).connect(this.#audioCtx.destination);
                        oscs.push(osc);
                    }

                    for (const osc of oscs) {
                        osc.start();
                        osc.stop(this.#audioCtx.currentTime + ChordPlayer.#chordLength);
                    }

                    oscs[0].onended = onEnded;
                }

                playChord(root, third, fifth, octave) {
                    this.#playChord(root, third, fifth, octave);
                }
                        
                playChords(chords) {
                    this.#stopPlayback();

                    let stopSignalSent = false;
                    this.dispatchEvent(new CustomEvent("playbackStarted"));

                    this.#stopPlayback = function () {
                        this.#stopPlayback = this.#defaultStopPlayback;
                        this.#stopPlayback();
                        stopSignalSent = true;
                        this.dispatchEvent(new CustomEvent("playbackEnded"));
                    }

                    const thisPlayer = this;

                    function playIndex(index) {
                        if (stopSignalSent == false) {

                            if (index < chords.length) {
                                thisPlayer.dispatchEvent(new CustomEvent("chordStarted", { detail: { index } }));
                                thisPlayer.#playChord(
                                    ...chords.getChord(index),
                                    () => {
                                        thisPlayer.dispatchEvent(new CustomEvent("chordEnded", { detail: { index } }));
                                        playIndex(index + 1);
                                    }
                                );
                            } else {
                                thisPlayer.dispatchEvent(new CustomEvent("playbackEnded"));
                            }
                        }
                    }

                    playIndex(0);
                }
            }

            class ChordHelper {
                static noteNames = Object.freeze(["C", "C‚ôØ", "D", "D‚ôØ", "E", "F", "F‚ôØ", "G", "G‚ôØ", "A", "A‚ôØ", "B"]);

                static thirdNames= Object.freeze({
                    2: "sus2",
                    3: "min",
                    4: "maj",
                    5: "sus4"
                });

                static fifthNames = Object.freeze({
                    5: "ùÑ´5",
                    6: "‚ô≠5",
                    7: "5",
                    8: "‚ôØ5"
                });

                static octaveNames =  Object.freeze(["-3", "-2", "-1", "+0", "+1", "+2", "+3"]);

                static thirds = Object.freeze({
                    "sus2": 2,
                    "min": 3,
                    "maj": 4,
                    "sus4": 5
                });

                static fifths = Object.freeze({
                    "perf4": 5,
                    "dim": 6,
                    "perf": 7,
                    "aug": 8
                });

                static chordNames =  Object.freeze({
                    [ChordHelper.thirds.sus2]: Object.freeze({
                        [ChordHelper.fifths.perf4]: "sus2ùÑ´5",
                        [ChordHelper.fifths.dim]: "sus2‚ô≠5",
                        [ChordHelper.fifths.perf]: "sus2",
                        [ChordHelper.fifths.aug]: "sus2‚ôØ5"
                    }),
                    [ChordHelper.thirds.min]: Object.freeze({
                        [ChordHelper.fifths.perf4]: "minùÑ´5",
                        [ChordHelper.fifths.dim]: "dim",
                        [ChordHelper.fifths.perf]: "min",
                        [ChordHelper.fifths.aug]: "min‚ôØ5"
                    }),
                    [ChordHelper.thirds.maj]: Object.freeze({
                        [ChordHelper.fifths.perf4]: "majùÑ´5",
                        [ChordHelper.fifths.dim]: "maj‚ô≠5",
                        [ChordHelper.fifths.perf]: "maj",
                        [ChordHelper.fifths.aug]: "aug"
                    }),
                    [ChordHelper.thirds.sus4]: Object.freeze({
                        [ChordHelper.fifths.dim]: "sus4‚ô≠5",
                        [ChordHelper.fifths.perf]: "sus4",
                        [ChordHelper.fifths.aug]: "sus4‚ôØ5"
                    })
                });

                static nameChord = function(root, third, fifth) {
                    const chordName = ChordHelper.chordNames[third][fifth];
                    if (chordName) {
                        return ` ${ChordHelper.noteNames[root]}${chordName}`;
                    } else {
                        return undefined;
                    }
                };
            
                static spellChord = function(root, third, fifth) {
                    const rootNodes = ChordHelper.noteNames[root];
                    const thirdNodes = ChordHelper.noteNames[(root + third) % 12];
                    const fifthNodes = ChordHelper.noteNames[(root + fifth) % 12];
                    return `${rootNodes} ${thirdNodes} ${fifthNodes}`;
                };

                static lowerRoot = function(root, third, fifth) {
                    const newRoot = (root - 1 + 12) % 12;
                    const newThird = (third + 1) % 12;
                    const newFifth = (fifth + 1) % 12;
                    
                    return [newRoot, newThird, newFifth];
                };
                
                static raiseRoot = function(root, third, fifth) {
                    const newRoot = (root + 1) % 12;
                    const newThird = (third - 1 + 12) % 12;
                    const newFifth = (fifth - 1 + 12) % 12;
                    
                    return [newRoot, newThird, newFifth];
                };
                
                static lowerThird = function(root, third, fifth) {
                    const newRoot = root;
                    const newThird = (third - 1 + 12) % 12;
                    const newFifth = fifth;
                    
                    return [newRoot, newThird, newFifth];
                };
                
                static raiseThird(root, third, fifth) {
                    const newRoot = root;
                    const newThird = (third + 1) % 12;
                    const newFifth = fifth;
                    
                    return [newRoot, newThird, newFifth];
                }
                
                static lowerFifth(root, third, fifth) {
                    const newRoot = root;
                    const newThird = third;
                    const newFifth = (fifth - 1 + 12) % 12;
                    
                    return [newRoot, newThird, newFifth];
                }
                
                static raiseFifth(root, third, fifth) {
                    const newRoot = root;
                    const newThird = third;
                    const newFifth = (fifth + 1) % 12;
                    
                    return [newRoot, newThird, newFifth];
                }
                
                static findRootPosition(root, third, fifth) {
                    if (
                        ChordHelper.chordNames[third] !== undefined
                        && ChordHelper.chordNames[third][fifth] !== undefined
                    ) {
                        return [root, third, fifth];
                    } else {
                        return null;
                    }
                }

                static findFirstInversion(root, third, fifth) {
                    const newRoot = (root + third) % 12;
                    const newThird = (12 + fifth - third) % 12;
                    const newFifth = (12 - third) % 12;

                    if (
                        ChordHelper.chordNames[newThird] !== undefined
                        && ChordHelper.chordNames[newThird][newFifth] !== undefined
                    ) {
                        return [newRoot, newThird, newFifth];
                    } else {
                        return null;
                    }
                }

                static findSecondInversion(root, third, fifth) {
                    const newRoot = (root + fifth) % 12;
                    const newThird = (12 - fifth) % 12;
                    const newFifth = (12 + third - fifth) % 12;

                    if (
                        ChordHelper.chordNames[newThird] !== undefined
                        && ChordHelper.chordNames[newThird][newFifth] !== undefined
                    ) {
                        return [newRoot, newThird, newFifth];
                    } else {
                        return null;
                    }
                }

                static findInversions(root, third, fifth) {
                    const rootPosition = ChordHelper.findRootPosition(root, third, fifth);
                    const firstInversion = ChordHelper.findFirstInversion(root, third, fifth);
                    const secondInversation = ChordHelper.findSecondInversion(root, third, fifth);

                    const inversions = [];
                    if (rootPosition) inversions.push(rootPosition);
                    if (firstInversion) inversions.push(firstInversion);
                    if (secondInversation) inversions.push(secondInversation);
                    return inversions;
                }
            };


            const staveMetrics = {
                chordWidth: 150,
                clefWidth: 50,
                staveHeight: 130,
                topMargin: 30,
                horizontalMargin: 20,
                maxChords: 6
            };

            const staveNoteNames = ["c", "c#", "d", "d#", "e", "f", "f#", "g", "g#", "a", "a#", "b"];


            function renderChordGraph(root, third, fifth, octave, target) {
                function getChordGraphElement(root, third, fifth, octave) {
                    function getChordCollectionElement(root, third, fifth, octave) {
                        function getChordElement(root, third, fifth, octave) {
                            if (root === null) return null;

                            const el = document.createElement("button");
                            el.setAttribute("type", "button");
                            el.classList.add("chord");
                            el.innerHTML =
                                `${ChordHelper.nameChord(root, third, fifth)} (${ChordHelper.spellChord(root, third, fifth)})`;

                            el.addEventListener("click", () => {
                                el.dispatchEvent(new CustomEvent(
                                    "chordPushed",
                                    {
                                        bubbles: true,
                                        detail: [ root, third, fifth, octave ]
                                    }
                                ));
                            });
                            return el;
                        }

                        if (root === null) return null;

                        const el = document.createElement("div");
                        el.classList.add("chord-collection");
                        const inversions = ChordHelper.findInversions(root, third, fifth);
                        for (const inversion of inversions) {
                            el.append(getChordElement(...inversion, octave));
                        }
                        return el;
                    }

                    function getOctaveControlElement(octave) {
                        const el = document.createElement("div");

                        const upButton = document.createElement("button");
                        upButton.id = "octave-up";
                        upButton.innerText = "Octave Up";
                        upButton.addEventListener("click", () => {
                            el.dispatchEvent(new CustomEvent(
                                "octaveIncreased",
                                {
                                    bubbles: true
                                }
                            ));
                        });
                        el.appendChild(upButton);

                        const downButton = document.createElement("button");
                        downButton.id = "octave-down";
                        downButton.innerText = "Octave Down";
                        downButton.addEventListener("click", () => {
                            el.dispatchEvent(new CustomEvent(
                                "octaveDecreased",
                                {
                                    bubbles: true
                                }
                            ));
                        });
                        el.appendChild(downButton);

                        return el;
                    }

                    const table = document.createElement("div");
                    table.classList.add("chord-graph");
                    const topRow = document.createElement("div");
                    const middleRow = document.createElement("div");
                    const bottomRow = document.createElement("div");
                    topRow.append(
                        document.createElement("div"),
                        getChordCollectionElement(...ChordHelper.raiseRoot(root, third, fifth), octave),
                        getChordCollectionElement(...ChordHelper.raiseThird(root, third, fifth), octave)
                    );
                    middleRow.append(
                        getChordCollectionElement(...ChordHelper.lowerFifth(root, third, fifth), octave),
                        getChordCollectionElement(root, third, fifth, octave),
                        getChordCollectionElement(...ChordHelper.raiseFifth(root, third, fifth), octave)
                    );
                    bottomRow.append(
                        getChordCollectionElement(...ChordHelper.lowerThird(root, third, fifth), octave),
                        getChordCollectionElement(...ChordHelper.lowerRoot(root, third, fifth), octave),
                        getOctaveControlElement(octave)
                    );
                    table.append(topRow, middleRow, bottomRow);
                    return table;
                }

                const graph = getChordGraphElement(root, third, fifth, octave);
                const oldGraph = target.querySelector("& > .chord-graph");
                if (oldGraph) {
                    oldGraph.replaceWith(graph);
                } else {
                    target.append(graph);
                }
            }

            function renderChordPicker(root, third, fifth, octave, target) {
                function getChordPickerElement(root, third, fifth, octave) {
                    const picker = document.createElement("div");
                    picker.classList.add("chord-picker");

                    const rootPicker = document.createElement("select");
                    rootPicker.setAttribute("id", "picker-root");
                    for (const index in ChordHelper.noteNames) {
                        const option = document.createElement("option");
                        option.setAttribute("value", index);
                        option.innerText = ChordHelper.noteNames[index];
                        if (parseInt(index) === root) {
                            option.setAttribute("selected", "selected");
                        }
                        rootPicker.appendChild(option);
                        rootPicker.addEventListener("change", () => {
                            root = parseInt(rootPicker.value);
                            setButtonName();
                        });
                    }
                    picker.appendChild(rootPicker);

                    const thirdPicker = document.createElement("select");
                    thirdPicker.setAttribute("id", "picker-third");
                    for (const index in ChordHelper.thirdNames) {
                        const option = document.createElement("option");
                        option.setAttribute("value", index);
                        option.innerText = ChordHelper.thirdNames[index];
                        if (parseInt(index) === third) {
                            option.setAttribute("selected", "selected");
                        }
                        thirdPicker.appendChild(option);
                        thirdPicker.addEventListener("change", () => {
                            third = parseInt(thirdPicker.value);
                            setButtonName();
                        });
                    }
                    picker.appendChild(thirdPicker);

                    const fifthPicker = document.createElement("select");
                    fifthPicker.setAttribute("id", "picker-fifth");
                    for (const index in ChordHelper.fifthNames) {
                        const option = document.createElement("option");
                        option.setAttribute("value", index);
                        option.innerText = ChordHelper.fifthNames[index];
                        if (parseInt(index) === fifth) {
                            option.setAttribute("selected", "selected");
                        }
                        fifthPicker.appendChild(option);
                        fifthPicker.addEventListener("change", () => {
                            fifth = parseInt(fifthPicker.value);
                            setButtonName();
                        });
                    }
                    picker.appendChild(fifthPicker);

                    const octavePicker = document.createElement("select");
                    octavePicker.setAttribute("id", "picker-octave");
                    for (const name of ChordHelper.octaveNames.toReversed()) {
                        const index = parseInt(name);
                        const option = document.createElement("option");
                        option.setAttribute("value", index);
                        option.innerText = name;
                        if (index === octave) {
                            option.setAttribute("selected", "selected");
                        }
                        octavePicker.appendChild(option);
                        octavePicker.addEventListener("change", () => {
                            octave = parseInt(octavePicker.value);
                        });
                    }
                    picker.appendChild(octavePicker);

                    const button = document.createElement("button");
                    button.setAttribute("id", "picker-submit");
                    function setButtonName() {
                        const chordName = ChordHelper.nameChord(root, third, fifth);
                        if (chordName) {
                            button.innerText =
                                `${chordName} (${ChordHelper.spellChord(root, third, fifth)})`;;
                            button.disabled = false;
                        } else {
                            button.innerText = "Chord undefined";
                            button.disabled = true;
                        }
                    }
                    button.addEventListener("click", () => {
                        button.dispatchEvent(new CustomEvent(
                            "chordPushed",
                            {
                                bubbles: true,
                                detail: [ root, third, fifth, octave ]
                            }
                        ));
                    });
                    setButtonName();
                    picker.appendChild(button);

                    return picker;
                }

                const picker = getChordPickerElement(root, third, fifth, octave);
                const oldPicker = target.querySelector("& > .chord-picker");
                if (oldPicker) {
                    oldPicker.replaceWith(picker);
                } else {
                    target.append(picker);
                }
            }

            function renderStaves(chords) {
                function createStaveChord(root, third, fifth, octave) {
                    const position = 4 + octave;
                    const keys = [
                        `${staveNoteNames[root]}/${position}`,
                        `${staveNoteNames[(root + third) % 12]}/${position + Math.floor((root + third) / 12)}`,
                        `${staveNoteNames[(root + fifth) % 12]}/${position + Math.floor((root + fifth) / 12)}`
                    ];

                    const chord =  new StaveNote(
                        {
                            keys,
                            duration: "w"
                        }
                    );
                    
                    for (const index in keys) {
                        if (keys[index].includes("#")) {
                            chord.addModifier(new Accidental("#"), parseInt(index))
                        }
                    }

                    return chord;
                }
            
                function createStaveChordName(root, third, fifth) {
                    return new TextNote({
                        text: ChordHelper.nameChord(root, third, fifth),
                        duration: "w",
                        font: {
                            family: "system-ui",
                            size: 15,
                            weight: ""
                        },
                        justification: TextNote.Justification.LEFT,
                        line: 0
                    });
                }
            
                function renderStave(notes, chordNames, context, top) {
                    const notesWidth = notes.length * staveMetrics.chordWidth;

                    const stave = new Stave(staveMetrics.horizontalMargin, top, notesWidth + staveMetrics.clefWidth);
                    stave.addClef("treble");
                    stave.setContext(context);

                    const voice = new Voice({ num_beats: notes.length, beat_value: 1 }).setContext(context);
                    const notesWithBarlines = [].concat(...notes.map(n => [n, new BarNote()])).slice(0, -1);
                    voice.addTickables(notesWithBarlines).setStave(stave);
                    
                    const chordNameVoice = new Voice({ num_beats: notes.length, beat_value: 1 }).setContext(context);
                    chordNames.forEach(chordName => {
                        chordName.setStave(stave);
                    });
                    const chordNamesWithBarlines =  [].concat(...chordNames.map(n => [n, new BarNote()])).slice(0, -1);

                    chordNameVoice.addTickables(chordNamesWithBarlines).setStave(stave);

                    new Formatter().joinVoices([voice, chordNameVoice]).format([voice, chordNameVoice], notesWidth);

                    stave.draw();
                    voice.draw();
                    chordNameVoice.draw();
                }

                const notes = chords.map(chord => createStaveChord(...chord));
                const chordNames = chords.map(chord => createStaveChordName(...chord));
                const staveCount = Math.ceil(notes.length / staveMetrics.maxChords);

                const div = document.getElementById("staves");
                div.textContent = '';
                const renderer = new Renderer(div, Renderer.Backends.SVG);
                const canvasWidth = staveMetrics.maxChords * staveMetrics.chordWidth + staveMetrics.clefWidth + staveMetrics.horizontalMargin * 2;
                const canvasHeight = staveMetrics.topMargin + Math.max(1, staveCount) * staveMetrics.staveHeight;
                renderer.resize(canvasWidth, canvasHeight);
                const context = renderer.getContext();

                for (let staveIndex = 0; staveIndex < staveCount || staveIndex === 0; ++staveIndex) {
                    const staveNotes = notes.slice(staveIndex * staveMetrics.maxChords, (staveIndex + 1) * staveMetrics.maxChords);
                    const staveChordNames = chordNames.slice(staveIndex * staveMetrics.maxChords, (staveIndex + 1) * staveMetrics.maxChords);
                    renderStave(staveNotes, staveChordNames, context, staveMetrics.topMargin + staveIndex * (staveMetrics.staveHeight));
                }
            }


            document.addEventListener("DOMContentLoaded", () => {
                const chordHistory = new ChordHistory();
                const chordPlayer = new ChordPlayer();

                chordHistory.addEventListener("stateUpdated", updateUI);

                chordPlayer.addEventListener("chordStarted", (event) => {
                    document.querySelectorAll(".vf-stavenote")?.[event.detail.index]?.classList.add("highlight");
                });

                chordPlayer.addEventListener("chordEnded", (event) => {
                    document.querySelectorAll(".vf-stavenote")?.[event.detail.index]?.classList.remove("highlight");
                });

                chordPlayer.addEventListener("playbackStarted", () => {
                    document.getElementById("stop").disabled = false;
                });

                chordPlayer.addEventListener("playbackEnded", () => {
                    document.getElementById("stop").disabled = true;
                    document.querySelector(".vf-stavenote.highlight")?.classList.remove("highlight");
                });

                function setInitialChord() {
                    renderChordGraph(0, ChordHelper.thirds.maj, ChordHelper.fifths.perf, 0, document.getElementById("navigator"));
                    renderChordPicker(0, ChordHelper.thirds.maj, ChordHelper.fifths.perf, 0, document.getElementById("picker"));
                }

                function updateUI() {
                    chordPlayer.stopPlayback();
                    document.getElementById("stop").disabled = true;

                    if (chordHistory.latestChord) {
                        renderChordGraph(...chordHistory.latestChord, document.getElementById("navigator"));
                        renderChordPicker(...chordHistory.latestChord, document.getElementById("picker"));
                        chordPlayer.playChord(...chordHistory.latestChord);
                        document.getElementById("clear").disabled = false;
                        document.getElementById("play").disabled = false;
                        document.getElementById("octave-up").disabled = chordHistory.latestChord[3] >= 3;
                        document.getElementById("octave-down").disabled = chordHistory.latestChord[3] <= -3;
                    } else {
                        setInitialChord();
                        document.getElementById("octave-up").disabled = true;
                        document.getElementById("octave-down").disabled = true;
                        document.getElementById("clear").disabled = true;
                        document.getElementById("play").disabled = true;
                    }
                    
                    document.getElementById("undo").disabled = !chordHistory.canUndo;
                    document.getElementById("redo").disabled = !chordHistory.canRedo;
                    
                    renderStaves(chordHistory);
                }

                updateUI();

                document.addEventListener("chordPushed", () => chordHistory.push(event.detail));
                document.addEventListener("octaveIncreased", () => chordHistory.increaseOctave());
                document.addEventListener("octaveDecreased", () => chordHistory.decreaseOctave());
                document.getElementById("clear").addEventListener("click", () => chordHistory.clear());
                document.getElementById("undo").addEventListener("click", () => chordHistory.undo());
                document.getElementById("redo").addEventListener("click", () => chordHistory.redo());

                document.getElementById("play").addEventListener("click", () => chordPlayer.playChords(chordHistory));
                document.getElementById("stop").addEventListener("click", () => chordPlayer.stopPlayback());
            });
        </script>

        <style>
            html {
                font-family: system-ui;
                --theme-color: yellow;
                --border-radius: 0.4em;
                --chord-width: 11em;
            }

            body {
                display: flex;
                font-size: 1.2rem;
                flex-direction: column;
                align-items: center;
            }

            h1 {
                color: oklch(from var(--theme-color) 65% 20% h);
            }

            .chord-graph {
                display: table;
                border-spacing: 0.75em;

                > * {
                    display: table-row;
                    > * {
                        display: table-cell;
                        vertical-align: middle;
                        width: var(--chord-width);
                        height: 6em;
                    }
                }

                button {
                    margin: 0.25em 0;
                    width: 100%;
                }

                .chord-collection {
                    border: 0.15em solid oklch(from var(--theme-color) 80% 20% h);
                    border-radius: var(--border-radius);
                    background: oklch(from var(--theme-color) 98% 2% h);
                    padding: 0 0.25em;

                    .chord {
                        border: 0;
                        border-radius: var(--border-radius);
                        line-height: 0.9em;
                        user-select: none;
                        text-align: left;

                        &:hover {
                            cursor: pointer;
                            background: oklch(from var(--theme-color) 90% 10% h);
                        }
                    }
                }
            }

            .buttons, .chord-picker {
                margin: 1em 0;
            }

            .chord-picker button {
                width: var(--chord-width);
                line-height: 1.2em;
            }

            select, button {
                color: oklch(from var(--theme-color) 30% 30% h);
                border: 0.15em solid oklch(from var(--theme-color) 80% 20% h);
                border-radius: var(--border-radius);
                background: oklch(from var(--theme-color) 98% 2% h);
                padding: 0.25em 0.4em;
                margin: 0 0.4em;
                font-size: 1em;
                
                &:hover:not(:disabled, :active) {
                    background: oklch(from var(--theme-color) 90% 10% h);
                }
                
                &:active:not(:disabled)  {
                    background: oklch(from var(--theme-color) 94% 10% h);
                }

                &:disabled {
                    color: oklch(from var(--theme-color) 80% 10% h);
                    border-color: oklch(from var(--theme-color) 90% 10% h);
                    background: oklch(from var(--theme-color) 95% 2% h);
                }
            }

            .vf-stavenote.highlight {
                fill: oklch(from var(--theme-color) 70% 30% h);
            }
        </style>
    </head>
    <body>
        <h1>Chord Dancer</h1>
        <div id="picker"></div>
        <div id="navigator"></div>
        <div class="buttons">
            <button type="button" id="undo">Undo</button>
            <button type="button" id="redo">Redo</button>
        </div>
        <div class="buttons">
            <button type="button" id="play">Play</button>
            <button type="button" id="stop">Stop</button>
            <button type="button" id="clear">Clear</button>
        </div>
        <div id="staves"></div>
    </body>
</html>